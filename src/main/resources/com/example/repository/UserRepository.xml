<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.repository.UserRepository">
	<resultMap id="userMap" type="com.example.domain.User">
		<id			property="id"				column="user_id" ></id>
		<result 	property="name"				column="user_name" ></result>
		<result 	property="accountName"		column="account_name" ></result>
		<result 	property="email"			column="user_email" ></result>
		<result 	property="password"			column="user_password"></result>
		<result 	property="hireDate"			column="hire_date"></result>
		<result 	property="birthDay"			column="birth_day" ></result>
		<result 	property="serviceFk"		column="service_fk" ></result>
		<result 	property="serviceName"		column="service_name" ></result>
		<result 	property="introduction"		column="introduction" ></result>
		<result 	property="loginedTime"  	column="logined_time" />
		<result 	property="updatedTime"		column="updated_time" />
		<result 	property="registeredTime"	column="registered_time" />
		<result 	property="deleted"  		column="deleted" />
	</resultMap>
	<select id="findById" resultMap="userMap">
		SELECT
		*
		FROM
		users AS u
		JOIN 
		services AS s 
		ON 
		u.service_fk = s.service_id 
		WHERE
		u.user_id = #{id}
		AND
		u.deleted = false
	</select>
	<select id="findByEmail" resultMap="userMap">
		SELECT
		*
		FROM
		users AS u
		JOIN 
		services AS s 
		ON 
		u.service_fk = s.service_id 
		WHERE
		u.user_email= #{email}
		AND
		u.deleted = false 
	</select>
	<select id="findAll" resultMap="userMap">
		SELECT
		*
		FROM
		users AS u
		JOIN 
		services AS s 
		ON 
		u.service_fk = s.service_id 
		WHERE
		u.deleted = false 
	</select>
	<insert id="insertUser" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO users (user_name,account_name,user_email,user_password,hire_date,service_fk,birth_day,introduction)
		VALUES 				(#{name},#{accountName},#{email},#{password},#{hireDate},#{serviceFk},#{birthDay},#{introduction})
	  <selectKey resultType="int" keyProperty="id" order="AFTER">
      	select @@IDENTITY
	  </selectKey>
	</insert>
	<update id="updateUser">
		UPDATE
		users 
		SET 
		user_name = #{name},
		account_name = #{accountName},
		user_email = #{email},
		user_password = #{password},
		hire_date = #{hireDate},
		service_fk = #{serviceFk},
		birth_day = #{birthDay},
		introduction = #{introduction} ,
		updated_time = now() 
		WHERE
		user_id = #{id}
	</update>
	<update id="loginedUpdate">
		UPDATE
		users 
		SET 
		logined_time = now() 
		WHERE
		user_id = #{id}
	</update>
	
	<resultMap id="mailMap" type="com.example.domain.Mail">
		<id			property="id"				column="mail_id" ></id>
		<result 	property="email"			column="mail_email" ></result>
		<result 	property="name"				column="mail_user_name" ></result>
		<result 	property="token"			column="mail_token" ></result>
		<result 	property="status"			column="mail_status" ></result>
		<result 	property="registeredTime"	column="mail_registered_time" />
	</resultMap>
	<select id="findMailByToken" resultMap="mailMap">
		SELECT
		*
		FROM
		mails
		WHERE
		mail_token = #{token}
	</select>
	<select id="findMailByEmail" resultMap="mailMap">
		SELECT
		*
		FROM
		mails
		WHERE
		mail_email = #{email}
	</select>
	<insert id="insertMail" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO mails (mail_email, mail_user_name, mail_token, mail_status)
		VALUES (#{email},#{name},#{token},#{status})
		<selectKey resultType="int" keyProperty="id" order="AFTER">
      		select @@IDENTITY
	    </selectKey>
	</insert>
	<update id="changeStatusMail">
		UPDATE
		mails
		SET
		mail_status = #{status}
		WHERE
		mail_token = #{token}
	</update>
	<update id="changeTokenMail">
		UPDATE
		mails
		SET
		mail_token = #{token}
		WHERE
		mail_id = #{id}
	</update>
</mapper>